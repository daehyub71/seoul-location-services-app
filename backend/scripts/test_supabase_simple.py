"""
Supabase ê°„ë‹¨ ì—°ê²° í…ŒìŠ¤íŠ¸ (Python Clientë§Œ ì‚¬ìš©)
"""

import os
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

from dotenv import load_dotenv
from supabase import create_client, Client

load_dotenv()


def main():
    print("\n" + "ğŸš€"*30)
    print("Seoul Location Services - Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ (Simple)")
    print("ğŸš€"*30 + "\n")

    # Load credentials
    url = os.getenv('SUPABASE_URL')
    key = os.getenv('SUPABASE_KEY')

    if not url or not key:
        print("âŒ í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")
        print(f"   SUPABASE_URL: {url}")
        print(f"   SUPABASE_KEY: {'ì„¤ì •ë¨' if key else 'ì—†ìŒ'}")
        sys.exit(1)

    print(f"ğŸ“ Supabase URL: {url}")
    print(f"ğŸ”‘ API Key: {key[:30]}...\n")

    try:
        # Create client
        supabase: Client = create_client(url, key)
        print("âœ… 1. Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì„±ê³µ!\n")

        # Test tables
        print("="*60)
        print("í…Œì´ë¸” ì ‘ê·¼ í…ŒìŠ¤íŠ¸")
        print("="*60)

        tables = [
            'cultural_events',
            'libraries',
            'cultural_spaces',
            'public_reservations',
            'future_heritages',
            'collection_logs'
        ]

        all_success = True

        for table in tables:
            try:
                result = supabase.table(table).select('*', count='exact').limit(1).execute()
                count = result.count if result.count is not None else 0
                print(f"âœ… {table:<30} (ë ˆì½”ë“œ: {count}ê°œ)")
            except Exception as e:
                print(f"âŒ {table:<30} (ì˜¤ë¥˜: {str(e)[:50]}...)")
                all_success = False

        # Summary
        print("\n" + "="*60)
        if all_success:
            print("ğŸ‰ ëª¨ë“  í…Œì´ë¸” ì ‘ê·¼ ì„±ê³µ!")
            print("\në‹¤ìŒ ë‹¨ê³„:")
            print("1. Supabase SQL Editorì—ì„œ init_supabase_schema.sql ì‹¤í–‰")
            print("2. ë°ì´í„° ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (Day 3-5)")
            print("\ní…Œì´ë¸”ì´ ë¹„ì–´ìˆëŠ” ê²ƒì€ ì •ìƒì…ë‹ˆë‹¤.")
            print("ë°ì´í„° ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ë°ì´í„°ê°€ ì±„ì›Œì§‘ë‹ˆë‹¤.")
        else:
            print("âš ï¸  ì¼ë¶€ í…Œì´ë¸” ì ‘ê·¼ ì‹¤íŒ¨")
            print("\ní•´ê²° ë°©ë²•:")
            print("1. Supabase Dashboard â†’ SQL Editor ì ‘ì†")
            print("2. backend/scripts/init_supabase_schema.sql íŒŒì¼ ë‚´ìš© ë³µì‚¬")
            print("3. SQL Editorì— ë¶™ì—¬ë„£ê³  'Run' í´ë¦­")

        print("="*60 + "\n")

        # Test insert/update/delete
        print("="*60)
        print("CRUD ì‘ì—… í…ŒìŠ¤íŠ¸")
        print("="*60)

        try:
            # Insert test record
            print("\nğŸ“ í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œ ì‚½ì…...")
            insert_result = supabase.table('cultural_events').insert({
                'api_id': 'test_crud_001',
                'title': 'í…ŒìŠ¤íŠ¸ ë¬¸í™”í–‰ì‚¬',
                'lat': 37.5665,
                'lot': 126.9780
            }).execute()

            if insert_result.data:
                test_id = insert_result.data[0]['id']
                print(f"âœ… ì‚½ì… ì„±ê³µ! (ID: {test_id})")

                # Select
                print("\nğŸ” ë ˆì½”ë“œ ì¡°íšŒ...")
                select_result = supabase.table('cultural_events')\
                    .select('*')\
                    .eq('id', test_id)\
                    .execute()

                if select_result.data:
                    print(f"âœ… ì¡°íšŒ ì„±ê³µ! (ì œëª©: {select_result.data[0]['title']})")

                    # Check if location was auto-generated by trigger
                    has_location = select_result.data[0].get('location') is not None
                    if has_location:
                        print("âœ… Trigger ë™ì‘ í™•ì¸! location í•„ë“œ ìë™ ìƒì„±ë¨")
                    else:
                        print("âš ï¸  Trigger ë¯¸ë™ì‘: location í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤")

                # Update
                print("\nâœï¸  ë ˆì½”ë“œ ì—…ë°ì´íŠ¸...")
                update_result = supabase.table('cultural_events')\
                    .update({'title': 'í…ŒìŠ¤íŠ¸ ë¬¸í™”í–‰ì‚¬ (ìˆ˜ì •ë¨)'})\
                    .eq('id', test_id)\
                    .execute()

                if update_result.data:
                    print(f"âœ… ì—…ë°ì´íŠ¸ ì„±ê³µ!")

                # Delete
                print("\nğŸ—‘ï¸  í…ŒìŠ¤íŠ¸ ë ˆì½”ë“œ ì‚­ì œ...")
                delete_result = supabase.table('cultural_events')\
                    .delete()\
                    .eq('id', test_id)\
                    .execute()

                print("âœ… ì‚­ì œ ì„±ê³µ!")

                print("\nğŸ‰ ëª¨ë“  CRUD ì‘ì—… ì„±ê³µ!")

        except Exception as e:
            print(f"\nâŒ CRUD í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {str(e)}")

        print("="*60 + "\n")

        # Final summary
        print("="*60)
        print("ğŸ¯ ìµœì¢… ê²°ê³¼")
        print("="*60)
        print("âœ… Supabase ì—°ê²°: ì„±ê³µ")
        print("âœ… ê¸°ë³¸ ê¸°ëŠ¥: ì •ìƒ ë™ì‘")
        print("\nğŸ“Œ í˜„ì¬ ìƒíƒœ:")
        print("- Supabase Python Client ì—°ê²° ì™„ë£Œ")
        print("- í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ìƒì„± ì™„ë£Œ")
        print("- CRUD ì‘ì—… ê°€ëŠ¥")
        print("\nâš ï¸  ì£¼ì˜ì‚¬í•­:")
        print("- PostgreSQL ì§ì ‘ ì—°ê²°ì€ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤")
        print("- Python Clientë§Œìœ¼ë¡œë„ ëª¨ë“  ì‘ì—… ê°€ëŠ¥")
        print("- ë°ì´í„° ìˆ˜ì§‘ë¶€í„°ëŠ” Python Client ì‚¬ìš©")
        print("="*60 + "\n")

        print("ğŸš€ ì¤€ë¹„ ì™„ë£Œ! Day 2 ì‘ì—…ì„ ê³„ì† ì§„í–‰í•˜ì„¸ìš”.\n")

    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {type(e).__name__}")
        print(f"   ë©”ì‹œì§€: {str(e)}\n")
        sys.exit(1)


if __name__ == "__main__":
    main()
